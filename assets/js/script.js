// Starting global variables, get local storage and set start time and end time.
var eventsArray = localStorage.getItem("savedEvents");
var startTime = 9;
var endTime = 17;

// Populate events array, if it is empty or null (first time loading page)
// this function makes an empty array and adds time and empty strings. 
// Else loads eventsArray with content from local storage
function generateArray() {
    if (eventsArray == '' || eventsArray === null) {
        eventsArray = [];
        for (var i = startTime; i <= endTime; i++) {
            var time = moment(i, "h")
            eventsArray.push([time, ""]);
        }
        localStorage.setItem("savedEvents", JSON.stringify(eventsArray));
    }
    else {
        eventsArray = JSON.parse(localStorage.getItem("savedEvents"));
    }
}

// For each element inside eventsArray generate 1 timeblock, passing through the array element and its index in the loop
function generateTimeblocks() {
    eventsArray.forEach(function (x, index) {
        createTimeblock(x, index);
    })
}

// The array passed through is in this format [time, content], the time is used for the timeblock on the left 
// the content is used to fill in the task section with text (if any).
// HTML and text content is dynamically generated by nesting a <div> <textarea> <div> within a <div> called timeblock
function createTimeblock(blockArray, index) {
    var time = moment(blockArray[0]);
    var eventText = blockArray[1];

    var timeblock = $("<div>").addClass("time-block-container d-flex flex-row mb-3 mx-auto")
        .attr("data-index", index);
    var blockTime = $("<div>").text(time.format("h A"))
        .addClass("hour px-3");
    var blockText = $("<textarea>").text(eventText)
        .addClass("time-block flex-grow-1")
        .attr("placeholder", "Enter a task ...");
    var blockSave = $("<button>").text("Save").addClass("saveBtn");

    if (moment(time).isSame(currentDayTime, "hour")) {
        blockText.addClass("present");
    }
    else if (moment(time).isBefore(currentDayTime)) {
        blockText.addClass("past");
    }
    else if (moment(time).isAfter(currentDayTime)) {
        blockText.addClass("future");
    }

    timeblock.append(blockTime, blockText, blockSave);
    contanerEl.append(timeblock);
}

// jQuery selector for the #maincontainer which will house all of the timeblocks 
var contanerEl = $("#mainContainer");

// Event listener - on click of a save button get the data-index value of the parent and the text value of the 
// timeblock, and save them as variables to be pushed to the events array which is then saved to localstorage.
contanerEl.on("click", ".saveBtn", function (event) {
    var selectedEvent = $(event.target)
    var textContent = selectedEvent.parent().children("textarea").val();
    var blockIndex = selectedEvent.parent().attr("data-index");

    eventsArray[blockIndex][1] = textContent;
    localStorage.setItem("savedEvents", JSON.stringify(eventsArray));
});

// Generate current date using moment.js
var currentDayTime = moment();
$("#currentDay").text(currentDayTime.format("Do [of] MMMM YYYY"));

// Initialize page
generateArray();
generateTimeblocks();



